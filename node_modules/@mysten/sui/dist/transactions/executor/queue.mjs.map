{"version":3,"file":"queue.mjs","names":["#queue"],"sources":["../../../src/transactions/executor/queue.ts"],"sourcesContent":["// Copyright (c) Mysten Labs, Inc.\n// SPDX-License-Identifier: Apache-2.0\n\nexport class SerialQueue {\n\t#queue: Array<() => void> = [];\n\n\tasync runTask<T>(task: () => Promise<T>): Promise<T> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.#queue.push(() => {\n\t\t\t\ttask()\n\t\t\t\t\t.finally(() => {\n\t\t\t\t\t\tthis.#queue.shift();\n\t\t\t\t\t\tif (this.#queue.length > 0) {\n\t\t\t\t\t\t\tthis.#queue[0]();\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t.then(resolve, reject);\n\t\t\t});\n\n\t\t\tif (this.#queue.length === 1) {\n\t\t\t\tthis.#queue[0]();\n\t\t\t}\n\t\t});\n\t}\n}\n\nexport class ParallelQueue {\n\t#queue: Array<() => void> = [];\n\tactiveTasks = 0;\n\tmaxTasks: number;\n\n\tconstructor(maxTasks: number) {\n\t\tthis.maxTasks = maxTasks;\n\t}\n\n\trunTask<T>(task: () => Promise<T>): Promise<T> {\n\t\treturn new Promise<T>((resolve, reject) => {\n\t\t\tif (this.activeTasks < this.maxTasks) {\n\t\t\t\tthis.activeTasks++;\n\n\t\t\t\ttask()\n\t\t\t\t\t.finally(() => {\n\t\t\t\t\t\tif (this.#queue.length > 0) {\n\t\t\t\t\t\t\tthis.#queue.shift()!();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.activeTasks--;\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t.then(resolve, reject);\n\t\t\t} else {\n\t\t\t\tthis.#queue.push(() => {\n\t\t\t\t\ttask()\n\t\t\t\t\t\t.finally(() => {\n\t\t\t\t\t\t\tif (this.#queue.length > 0) {\n\t\t\t\t\t\t\t\tthis.#queue.shift()!();\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.activeTasks--;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(resolve, reject);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n}\n"],"mappings":";AAGA,IAAa,cAAb,MAAyB;CACxB,SAA4B,EAAE;CAE9B,MAAM,QAAW,MAAoC;AACpD,SAAO,IAAI,SAAS,SAAS,WAAW;AACvC,SAAKA,MAAO,WAAW;AACtB,UAAM,CACJ,cAAc;AACd,WAAKA,MAAO,OAAO;AACnB,SAAI,MAAKA,MAAO,SAAS,EACxB,OAAKA,MAAO,IAAI;MAEhB,CACD,KAAK,SAAS,OAAO;KACtB;AAEF,OAAI,MAAKA,MAAO,WAAW,EAC1B,OAAKA,MAAO,IAAI;IAEhB;;;AAIJ,IAAa,gBAAb,MAA2B;CAC1B,SAA4B,EAAE;CAI9B,YAAY,UAAkB;qBAHhB;AAIb,OAAK,WAAW;;CAGjB,QAAW,MAAoC;AAC9C,SAAO,IAAI,SAAY,SAAS,WAAW;AAC1C,OAAI,KAAK,cAAc,KAAK,UAAU;AACrC,SAAK;AAEL,UAAM,CACJ,cAAc;AACd,SAAI,MAAKA,MAAO,SAAS,EACxB,OAAKA,MAAO,OAAO,EAAG;SAEtB,MAAK;MAEL,CACD,KAAK,SAAS,OAAO;SAEvB,OAAKA,MAAO,WAAW;AACtB,UAAM,CACJ,cAAc;AACd,SAAI,MAAKA,MAAO,SAAS,EACxB,OAAKA,MAAO,OAAO,EAAG;SAEtB,MAAK;MAEL,CACD,KAAK,SAAS,OAAO;KACtB;IAEF"}