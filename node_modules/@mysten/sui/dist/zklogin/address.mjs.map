{"version":3,"file":"address.mjs","names":[],"sources":["../../src/zklogin/address.ts"],"sourcesContent":["// Copyright (c) Mysten Labs, Inc.\n// SPDX-License-Identifier: Apache-2.0\n\nimport { blake2b } from '@noble/hashes/blake2.js';\nimport { bytesToHex } from '@noble/hashes/utils.js';\n\nimport { SIGNATURE_SCHEME_TO_FLAG } from '../cryptography/signature-scheme.js';\nimport { normalizeSuiAddress, SUI_ADDRESS_LENGTH } from '../utils/index.js';\nimport { decodeJwt } from './jwt-utils.js';\nimport {\n\tgenAddressSeed,\n\tnormalizeZkLoginIssuer,\n\ttoBigEndianBytes,\n\ttoPaddedBigEndianBytes,\n} from './utils.js';\n\nexport function computeZkLoginAddressFromSeed(\n\taddressSeed: bigint,\n\tiss: string,\n\tlegacyAddress: boolean,\n) {\n\t// Explicitly check for people not using typescript and ignoring the major version migration guide\n\tif (legacyAddress === undefined) {\n\t\tthrow new Error('legacyAddress parameter must be specified');\n\t}\n\tconst addressSeedBytesBigEndian = legacyAddress\n\t\t? toBigEndianBytes(addressSeed, 32)\n\t\t: toPaddedBigEndianBytes(addressSeed, 32);\n\n\tconst addressParamBytes = new TextEncoder().encode(normalizeZkLoginIssuer(iss));\n\tconst tmp = new Uint8Array(2 + addressSeedBytesBigEndian.length + addressParamBytes.length);\n\n\ttmp.set([SIGNATURE_SCHEME_TO_FLAG.ZkLogin]);\n\ttmp.set([addressParamBytes.length], 1);\n\ttmp.set(addressParamBytes, 2);\n\ttmp.set(addressSeedBytesBigEndian, 2 + addressParamBytes.length);\n\n\treturn normalizeSuiAddress(\n\t\tbytesToHex(blake2b(tmp, { dkLen: 32 })).slice(0, SUI_ADDRESS_LENGTH * 2),\n\t);\n}\n\nexport const MAX_HEADER_LEN_B64 = 248;\nexport const MAX_PADDED_UNSIGNED_JWT_LEN = 64 * 25;\n\nexport function lengthChecks(jwt: string) {\n\tconst [header, payload] = jwt.split('.');\n\t/// Is the header small enough\n\tif (header.length > MAX_HEADER_LEN_B64) {\n\t\tthrow new Error(`Header is too long`);\n\t}\n\n\t/// Is the combined length of (header, payload, SHA2 padding) small enough?\n\t// unsigned_jwt = header + '.' + payload;\n\tconst L = (header.length + 1 + payload.length) * 8;\n\tconst K = (512 + 448 - ((L % 512) + 1)) % 512;\n\n\t// The SHA2 padding is 1 followed by K zeros, followed by the length of the message\n\tconst padded_unsigned_jwt_len = (L + 1 + K + 64) / 8;\n\n\t// The padded unsigned JWT must be less than the max_padded_unsigned_jwt_len\n\tif (padded_unsigned_jwt_len > MAX_PADDED_UNSIGNED_JWT_LEN) {\n\t\tthrow new Error(`JWT is too long`);\n\t}\n}\n\nexport function jwtToAddress(jwt: string, userSalt: string | bigint, legacyAddress: boolean) {\n\t// Explicitly check for people not using typescript and ignoring the major version migration guide\n\tif (legacyAddress === undefined) {\n\t\tthrow new Error('legacyAddress parameter must be specified');\n\t}\n\tlengthChecks(jwt);\n\n\tconst decodedJWT = decodeJwt(jwt);\n\n\treturn computeZkLoginAddress({\n\t\tuserSalt,\n\t\tclaimName: 'sub',\n\t\tclaimValue: decodedJWT.sub,\n\t\taud: decodedJWT.aud,\n\t\tiss: decodedJWT.iss,\n\t\tlegacyAddress,\n\t});\n}\n\nexport interface ComputeZkLoginAddressOptions {\n\tclaimName: string;\n\tclaimValue: string;\n\tuserSalt: string | bigint;\n\tiss: string;\n\taud: string;\n\tlegacyAddress: boolean;\n}\n\nexport function computeZkLoginAddress({\n\tclaimName,\n\tclaimValue,\n\tiss,\n\taud,\n\tuserSalt,\n\tlegacyAddress,\n}: ComputeZkLoginAddressOptions) {\n\t// Explicitly check for people not using typescript and ignoring the major version migration guide\n\tif (legacyAddress === undefined) {\n\t\tthrow new Error('legacyAddress parameter must be specified');\n\t}\n\treturn computeZkLoginAddressFromSeed(\n\t\tgenAddressSeed(userSalt, claimName, claimValue, aud),\n\t\tiss,\n\t\tlegacyAddress,\n\t);\n}\n"],"mappings":";;;;;;;;AAgBA,SAAgB,8BACf,aACA,KACA,eACC;AAED,KAAI,kBAAkB,OACrB,OAAM,IAAI,MAAM,4CAA4C;CAE7D,MAAM,4BAA4B,gBAC/B,iBAAiB,aAAa,GAAG,GACjC,uBAAuB,aAAa,GAAG;CAE1C,MAAM,oBAAoB,IAAI,aAAa,CAAC,OAAO,uBAAuB,IAAI,CAAC;CAC/E,MAAM,MAAM,IAAI,WAAW,IAAI,0BAA0B,SAAS,kBAAkB,OAAO;AAE3F,KAAI,IAAI,CAAC,yBAAyB,QAAQ,CAAC;AAC3C,KAAI,IAAI,CAAC,kBAAkB,OAAO,EAAE,EAAE;AACtC,KAAI,IAAI,mBAAmB,EAAE;AAC7B,KAAI,IAAI,2BAA2B,IAAI,kBAAkB,OAAO;AAEhE,QAAO,oBACN,WAAW,QAAQ,KAAK,EAAE,OAAO,IAAI,CAAC,CAAC,CAAC,MAAM,GAAG,qBAAqB,EAAE,CACxE;;AAGF,MAAa,qBAAqB;AAClC,MAAa,8BAA8B;AAE3C,SAAgB,aAAa,KAAa;CACzC,MAAM,CAAC,QAAQ,WAAW,IAAI,MAAM,IAAI;AAExC,KAAI,OAAO,SAAS,mBACnB,OAAM,IAAI,MAAM,qBAAqB;CAKtC,MAAM,KAAK,OAAO,SAAS,IAAI,QAAQ,UAAU;CACjD,MAAM,KAAK,OAAc,IAAI,MAAO,MAAM;AAM1C,MAHiC,IAAI,IAAI,IAAI,MAAM,IAGrB,4BAC7B,OAAM,IAAI,MAAM,kBAAkB;;AAIpC,SAAgB,aAAa,KAAa,UAA2B,eAAwB;AAE5F,KAAI,kBAAkB,OACrB,OAAM,IAAI,MAAM,4CAA4C;AAE7D,cAAa,IAAI;CAEjB,MAAM,aAAa,UAAU,IAAI;AAEjC,QAAO,sBAAsB;EAC5B;EACA,WAAW;EACX,YAAY,WAAW;EACvB,KAAK,WAAW;EAChB,KAAK,WAAW;EAChB;EACA,CAAC;;AAYH,SAAgB,sBAAsB,EACrC,WACA,YACA,KACA,KACA,UACA,iBACgC;AAEhC,KAAI,kBAAkB,OACrB,OAAM,IAAI,MAAM,4CAA4C;AAE7D,QAAO,8BACN,eAAe,UAAU,WAAW,YAAY,IAAI,EACpD,KACA,cACA"}